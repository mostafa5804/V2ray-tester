<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تستر هوشمند کانفیگ | نسخه ۵</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: { primary: '#2563eb', secondary: '#eff6ff', surface: '#ffffff' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid #e2e8f0; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .loader-spin { border: 2px solid #e2e8f0; border-top: 2px solid #2563eb; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* استایل منبع */
        .source-card { transition: all 0.2s; border: 1px solid #f1f5f9; }
        .source-checkbox:checked + .source-card { border-color: #3b82f6; background-color: #eff6ff; }
        .source-checkbox:checked + .source-card .check-icon { opacity: 1; transform: scale(1); }
        .count-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #64748b; }
        .count-badge.success { background: #dcfce7; color: #166534; }
        .count-badge.error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="pb-40 pt-16">

    <header class="fixed top-0 w-full z-40 bg-white/90 backdrop-blur-md border-b border-gray-200 h-14 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h1 class="font-bold text-gray-800 text-base">تستر کانفیگ</h1>
        </div>
        <div class="text-[10px] font-mono bg-gray-100 text-gray-500 px-2 py-1 rounded-full">V5.0 Decode+</div>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-5">

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-gray-700 text-xs flex items-center gap-2">
                    <i class="fas fa-server text-blue-500"></i> لیست منابع
                </h2>
                <div class="flex gap-2">
                    <button onclick="checkSelectedSources()" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1">
                        <i class="fas fa-sync-alt"></i> بروزرسانی تعداد
                    </button>
                    <button onclick="toggleSources(true)" class="text-[10px] bg-gray-50 text-gray-600 px-2 py-1 rounded hover:bg-gray-100">همه</button>
                </div>
            </div>
            
            <div id="sourcesGrid" class="grid grid-cols-1 gap-2 max-h-56 overflow-y-auto custom-scroll p-1">
                </div>
        </section>

        <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 space-y-2">
            <label class="text-xs font-bold text-gray-500 flex justify-between">
                <span>لینک دستی / سابسکریپشن</span>
                <span id="manualCount" class="text-blue-600 font-mono"></span>
            </label>
            <div class="relative">
                <textarea id="customInput" class="w-full h-20 p-3 text-xs bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 transition font-mono dir-ltr" placeholder="لینک خود را اینجا پیست کنید..."></textarea>
                <button onclick="checkManualLink()" class="absolute bottom-2 right-2 bg-blue-600 text-white text-[10px] px-3 py-1.5 rounded-lg shadow-md hover:bg-blue-700 transition flex items-center gap-1">
                    <i class="fas fa-search"></i> بررسی لینک
                </button>
            </div>
        </div>

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4">
            <div class="flex justify-between text-xs mb-2">
                <span class="text-gray-600 font-bold">تعداد خروجی نهایی:</span>
                <span id="limitDisplay" class="font-bold text-blue-600 bg-blue-50 px-2 rounded">50</span>
            </div>
            <input type="range" id="limitInput" min="5" max="500" value="50" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="document.getElementById('limitDisplay').innerText = this.value">
            
            <div class="flex items-center gap-3">
                <label class="flex-1 flex items-center gap-2 bg-gray-50 p-2.5 rounded-xl border border-gray-200 cursor-pointer">
                    <input type="checkbox" id="deepCheck" class="w-4 h-4 accent-blue-600 rounded">
                    <span class="text-[10px] font-bold text-gray-600">تست دقیق (پینگ واقعی)</span>
                </label>
            </div>
        </section>

        <button id="startBtn" onclick="startFullProcess()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm">
            <span>شروع آنالیز و تست سرعت</span>
            <i class="fas fa-rocket"></i>
        </button>

        <div id="statusArea" class="hidden text-center py-4 space-y-2">
            <div class="flex justify-center items-center gap-2 text-xs text-gray-500">
                <div class="loader-spin"></div>
                <span id="statusText">در حال آماده‌سازی...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div id="progressBar" class="bg-blue-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-3">
            <div class="flex justify-between items-center px-1 border-b border-gray-200 pb-2">
                <h3 class="font-bold text-gray-800 text-xs">خروجی (<span id="countVal">0</span>)</h3>
                <div class="flex gap-2">
                    <button onclick="filterResults('all')" class="text-[10px] text-blue-600 font-bold">همه</button>
                    <button onclick="filterResults('vless')" class="text-[10px] text-gray-500">VLESS</button>
                    <button onclick="filterResults('vmess')" class="text-[10px] text-gray-500">VMess</button>
                </div>
            </div>
            <div id="cardsContainer" class="space-y-2"></div>
        </div>

    </main>

    <div id="actionBar" class="hidden fixed bottom-6 left-0 w-full px-4 z-40">
        <div class="max-w-xl mx-auto glass-panel p-2 rounded-2xl shadow-2xl flex gap-2">
            <button onclick="copyAll()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-md active:bg-blue-700 transition">
                کپی کانفیگ‌های سالم
            </button>
            <button onclick="downloadSub()" class="flex-1 bg-white text-gray-700 border border-gray-200 py-3 rounded-xl font-bold text-xs shadow-sm hover:bg-gray-50 transition">
                دانلود فایل TXT
            </button>
        </div>
    </div>

    <div id="qrModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onclick="document.getElementById('qrModal').classList.add('hidden')">
        <div class="bg-white rounded-2xl p-5 text-center shadow-2xl" onclick="event.stopPropagation()">
            <div id="qrPlace" class="flex justify-center mb-3"></div>
            <button onclick="document.getElementById('qrModal').classList.add('hidden')" class="text-xs text-red-500 font-bold">بستن</button>
        </div>
    </div>

    <script>
        // --- منابع ---
        // لیست منابع که شامل لینک‌های Base64 و متنی است
        const sources = [
            { id: 's1', name: "Barry-Far (Base64)", url: "https://raw.githubusercontent.com/barry-far/V2ray-config/main/All_Configs_base64_Sub.txt" },
            { id: 's2', name: "ALIILAPRO (Mix)", url: "https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/server.txt" },
            { id: 's3', name: "V2RayRoot", url: "https://raw.githubusercontent.com/V2RayRoot/V2RayConfig/main/Config/vless.txt" },
            { id: 's4', name: "ShatakVPN", url: "https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/main/configs/all.txt" },
            { id: 's5', name: "MatinGhanbari", url: "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/all_sub.txt" },
            { id: 's6', name: "Epodonios", url: "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt" },
            { id: 's7', name: "HamedCode", url: "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/sub/vless.txt" },
            { id: 's8', name: "AvenCores 1", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/1.txt" }
        ];

        let validConfigs = [];
        let allFetchedConfigs = [];

        // --- رندر اولیه ---
        function renderSources() {
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = '';
            sources.forEach((src, idx) => {
                grid.innerHTML += `
                    <label class="cursor-pointer relative group block">
                        <input type="checkbox" value="${src.url}" data-id="${src.id}" class="source-checkbox hidden" checked>
                        <div class="source-card bg-white rounded-xl p-3 flex items-center justify-between select-none">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fas fa-check-circle text-blue-500 opacity-0 check-icon transition-transform scale-50"></i>
                                <span class="font-bold text-xs text-gray-700 truncate">${src.name}</span>
                            </div>
                            <div id="badge-${src.id}" class="count-badge">چک نشده</div>
                        </div>
                    </label>
                `;
            });
        }

        function toggleSources(state) {
            document.querySelectorAll('.source-checkbox').forEach(cb => cb.checked = state);
        }

        // --- توابع هسته (Core Logic) ---

        // 1. دانلود با پروکسی (برای دور زدن محدودیت‌های ایران و گیت‌هاب)
        async function fetchContent(url) {
            const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 8000); // 8 ثانیه تایم‌اوت دانلود
                const res = await fetch(proxy, { signal: controller.signal });
                clearTimeout(id);
                if (!res.ok) throw new Error('Network Error');
                return await res.text();
            } catch (e) {
                console.error("Fetch Error:", e);
                return null;
            }
        }

        // 2. دیکودر هوشمند (شاه‌کلید حل مشکل!)
        function smartExtract(text) {
            if (!text) return [];
            let configs = [];
            text = text.trim();

            // الف: آیا این یک فایل Base64 خالص است؟ (مثل barry-far)
            if (!text.includes('://') && /^[a-zA-Z0-9+/=\n\r]+$/.test(text)) {
                try {
                    const decoded = atob(text.replace(/[\n\r\s]/g, ''));
                    // حالا داخل متن دیکود شده دنبال کانفیگ بگرد
                    const extracted = decoded.match(/(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g);
                    if (extracted) configs.push(...extracted);
                } catch (e) {
                    console.log("Base64 Decode Failed, trying regex directly");
                }
            }
            
            // ب: جستجوی مستقیم (برای فایل‌های متنی معمولی مثل ALIILAPRO)
            const directMatches = text.match(/(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g);
            if (directMatches) configs.push(...directMatches);

            // حذف تکراری‌ها و تمیزکاری
            return [...new Set(configs)];
        }

        // --- بخش 1: بررسی منابع (شمارش) ---
        
        async function checkSelectedSources() {
            const checkedBoxes = document.querySelectorAll('.source-checkbox:checked');
            if (checkedBoxes.length === 0) return alert("منبعی انتخاب نشده!");

            for (const box of checkedBoxes) {
                const url = box.value;
                const id = box.dataset.id;
                const badge = document.getElementById(`badge-${id}`);
                
                badge.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                
                const content = await fetchContent(url);
                const configs = smartExtract(content);
                
                if (configs.length > 0) {
                    badge.className = "count-badge success";
                    badge.innerText = `✅ ${configs.length}`;
                } else {
                    badge.className = "count-badge error";
                    badge.innerText = "❌ 0";
                }
            }
        }

        async function checkManualLink() {
            const input = document.getElementById('customInput');
            const badge = document.getElementById('manualCount');
            const url = input.value.trim();

            if (!url) return alert("لینک خالی است!");
            
            badge.innerHTML = `<i class="fas fa-spinner fa-spin"></i> بررسی...`;

            // اگر مستقیماً کانفیگ وارد کرده باشد
            if (url.startsWith('vmess') || url.startsWith('vless')) {
                const lines = url.split('\n').filter(l => l.includes('://'));
                badge.innerText = `${lines.length} کانفیگ (دستی)`;
                return;
            }

            // اگر لینک باشد (دانلود نیاز دارد)
            const content = await fetchContent(url);
            const configs = smartExtract(content);
            
            if (configs.length > 0) {
                badge.innerText = `✅ ${configs.length} کانفیگ یافت شد`;
                badge.className = "text-green-600 font-mono text-xs";
            } else {
                badge.innerText = "❌ کانفیگی یافت نشد";
                badge.className = "text-red-500 font-mono text-xs";
            }
        }

        // --- بخش 2: شروع تست (Main Process) ---

        async function startFullProcess() {
            // جمع‌آوری تمام کانفیگ‌ها
            allFetchedConfigs = [];
            const checkedBoxes = document.querySelectorAll('.source-checkbox:checked');
            const customText = document.getElementById('customInput').value.trim();
            const limit = parseInt(document.getElementById('limitInput').value);
            const deepCheck = document.getElementById('deepCheck').checked;

            // UI Reset
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('actionBar').classList.add('hidden');
            document.getElementById('cardsContainer').innerHTML = '';
            validConfigs = [];

            const status = document.getElementById('statusText');
            const pBar = document.getElementById('progressBar');

            // 1. دانلود و استخراج (اگر قبلاً چک نشده باشند، الان انجام می‌شود)
            status.innerText = "در حال جمع‌آوری کانفیگ‌ها...";
            let sourcesProcessed = 0;
            
            // افزودن دستی‌ها
            if (customText) {
                if (customText.startsWith('http')) {
                    const content = await fetchContent(customText);
                    allFetchedConfigs.push(...smartExtract(content));
                } else {
                    allFetchedConfigs.push(...smartExtract(customText));
                }
            }

            // افزودن منابع انتخابی
            for (const box of checkedBoxes) {
                const content = await fetchContent(box.value);
                const configs = smartExtract(content);
                allFetchedConfigs.push(...configs);
                
                sourcesProcessed++;
                pBar.style.width = `${(sourcesProcessed / checkedBoxes.length) * 20}%`;
            }

            // حذف تکراری نهایی
            allFetchedConfigs = [...new Set(allFetchedConfigs)];

            if (allFetchedConfigs.length === 0) {
                alert("هیچ کانفیگی برای تست یافت نشد!");
                location.reload();
                return;
            }

            // 2. تست اتصال
            status.innerText = `شروع تست سرعت روی ${allFetchedConfigs.length} کانفیگ...`;
            
            // برای سرعت، تعداد تست را محدود می‌کنیم (مثلاً 5 برابر لیمیت درخواستی)
            const maxTests = Math.min(allFetchedConfigs.length, limit * 5);
            const configsToTest = allFetchedConfigs.slice(0, maxTests);
            
            let checked = 0;
            const batchSize = 10;

            for (let i = 0; i < configsToTest.length; i += batchSize) {
                const batch = configsToTest.slice(i, i + batchSize);
                const promises = batch.map(c => checkConfig(c, deepCheck));
                const results = await Promise.all(promises);

                results.forEach(res => {
                    if (res.alive) validConfigs.push(res);
                });

                checked += batch.length;
                let percent = 20 + ((checked / configsToTest.length) * 80);
                pBar.style.width = `${percent}%`;
                status.innerText = `تست شده: ${checked} | سالم: ${validConfigs.length}`;

                // اگر به اندازه کافی کانفیگ سالم پیدا کردیم، متوقف شو
                if (validConfigs.length >= limit * 1.2) break;
            }

            // 3. نمایش
            validConfigs.sort((a, b) => a.ping - b.ping);
            validConfigs = validConfigs.slice(0, limit);
            renderResults('all');

            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('actionBar').classList.remove('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').innerText = "شروع مجدد";
        }

        // --- تابع تست اتصال (Browser Trick) ---
        async function checkConfig(config, deep) {
            const start = Date.now();
            let ip, port;

            // پارس کردن کانفیگ برای پیدا کردن IP:Port
            try {
                if (config.startsWith('vmess')) {
                    const json = JSON.parse(atob(config.replace('vmess://', '')));
                    ip = json.add; port = json.port;
                } else {
                    // VLESS / Trojan / SS
                    const match = config.match(/@([^:]+):(\d+)/) || config.match(/\/\/([^:]+):(\d+)/);
                    if (match) { ip = match[1]; port = match[2]; }
                }
            } catch { return { alive: false }; }

            if (!ip || !port) return { alive: false };

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 2000); // 2 ثانیه تایم‌اوت
                
                // تلاش برای فچ کردن HTTP از پورت
                // اگر پورت باز باشد، سریع ارور Network (یا CORS) می‌دهد.
                // اگر بسته/فیلتر باشد، Timeout (AbortError) می‌دهد.
                await fetch(`http://${ip}:${port}`, { mode: 'no-cors', signal: controller.signal });
                
                clearTimeout(timeout);
                return { alive: true, ping: Date.now() - start, config, ip, port };
            } catch (err) {
                if (err.name === 'AbortError') return { alive: false }; // Timeout = Dead
                // هر ارور دیگری یعنی سرور جواب داد (حتی اگر ارور داد) = Alive
                return { alive: true, ping: Date.now() - start, config, ip, port };
            }
        }

        // --- نمایش نتایج ---
        function renderResults(filter) {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            const list = filter === 'all' ? validConfigs : validConfigs.filter(c => c.config.startsWith(filter));
            document.getElementById('countVal').innerText = list.length;

            list.forEach(item => {
                let type = item.config.split('://')[0].toUpperCase();
                let pingClass = item.ping < 500 ? 'text-green-600' : 'text-yellow-600';
                let name = 'Config';
                if (item.config.includes('#')) name = decodeURIComponent(item.config.split('#')[1]);

                container.innerHTML += `
                    <div class="bg-white border border-gray-100 rounded-xl p-3 flex justify-between items-center shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="bg-blue-50 text-blue-600 font-bold text-[10px] px-2 py-1 rounded">${type}</span>
                            <div class="truncate">
                                <div class="font-bold text-xs text-gray-700 truncate w-40">${name}</div>
                                <div class="text-[10px] text-gray-400 font-mono truncate w-40">${item.ip}:${item.port}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold font-mono ${pingClass}">${item.ping}ms</span>
                            <button onclick="showQr('${encodeURIComponent(item.config)}')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-qrcode"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function filterResults(type) {
            renderResults(type);
        }

        // --- ابزارها ---
        function showQr(config) {
            config = decodeURIComponent(config);
            const modal = document.getElementById('qrModal');
            const place = document.getElementById('qrPlace');
            place.innerHTML = '';
            new QRCode(place, { text: config, width: 180, height: 180 });
            modal.classList.remove('hidden');
        }

        function copyAll() {
            const txt = validConfigs.map(c => c.config).join('\n');
            navigator.clipboard.writeText(txt).then(() => alert('کپی شد!'));
        }

        function downloadSub() {
            const txt = validConfigs.map(c => c.config).join('\n');
            const blob = new Blob([btoa(txt)], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Subscription.txt';
            link.click();
        }

        // اجرا
        renderSources();
    </script>
</body>
</html>
