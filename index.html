<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³ØªØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ V2Ray (Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ)</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #ffffff; border-radius: 20px; box-shadow: 0 25px 70px rgba(0,0,0,0.25); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; font-weight: 700; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 1.3em; font-weight: 600; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; width: 4px; height: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 2px; }
        .sources-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .source-item { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 2px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .source-item:hover { border-color: #667eea; transform: translateY(-2px); }
        .source-item.selected { background: #f0f4ff; border-color: #667eea; }
        .source-checkbox { display: flex; align-items: center; gap: 12px; }
        .source-name { font-weight: 600; color: #333; }
        .selection-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-selection { padding: 10px 20px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; cursor: pointer; font-family: inherit; }
        textarea { width: 100%; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-family: monospace; min-height: 120px; }
        .btn-start { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 20px;}
        .btn-start:disabled { background: #ccc; cursor: not-allowed; }
        .progress { display: none; margin-top: 25px; background: #f8f9fa; padding: 15px; border-radius: 12px; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #667eea; width: 0%; transition: width 0.3s; }
        .results { display: none; margin-top: 30px; }
        .config-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .config-ping { font-weight: bold; }
        .config-ping.fast { color: #28a745; }
        .config-ping.medium { color: #ffc107; }
        .config-ping.slow { color: #dc3545; }
        .action-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .action-btn { padding: 12px; border: none; border-radius: 8px; color: white; cursor: pointer; font-family: inherit; }
        .btn-copy { background: #28a745; }
        .btn-download { background: #17a2b8; }
        .btn-sub { background: #6f42c1; }
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± */
        .slider-control { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        input[type=range] { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ØªØ³ØªØ± ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯ V2Ray</h1>
            <p>ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø´Ù…Ø§ (Real Latency)</p>
        </div>

        <div class="content">
            <div id="alert" class="alert"></div>

            <div class="section">
                <div class="section-title">ğŸ“¦ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù†Ø§Ø¨Ø¹</div>
                <div class="selection-controls">
                    <button class="btn-selection" onclick="toggleAll(true)">âœ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡</button>
                    <button class="btn-selection" onclick="toggleAll(false)">âœ— Ø­Ø°Ù Ù‡Ù…Ù‡</button>
                </div>
                <div class="sources-grid" id="sourcesGrid"></div>
            </div>

            <div class="section">
                <div class="section-title">âœï¸ ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø³ØªÛŒ</div>
                <textarea id="customInput" placeholder="Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© ÛŒØ§ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>

            <div class="section">
                <div class="section-title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
                <div class="slider-control">
                    <span>ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÙˆØ¬ÛŒ: </span>
                    <span id="limitVal" style="font-weight:bold; color:#667eea">20</span>
                    <input type="range" id="outputLimit" min="5" max="200" value="20" oninput="document.getElementById('limitVal').innerText = this.value">
                </div>
            </div>

            <button id="startBtn" class="btn-start" onclick="startProcess()">ğŸš€ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ ØªØ³Øª ÙˆØ§Ù‚Ø¹ÛŒ</button>

            <div class="progress" id="progressArea">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <p id="progressText" style="text-align:center; margin-top:10px; font-size:0.9em; color:#666">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹...</p>
            </div>

            <div class="results" id="resultsArea">
                <div style="background:#f0f4ff; padding:15px; border-radius:10px; margin-bottom:10px;">
                    <h3>âœ… Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ</h3>
                    <p id="resultStats" style="color:#666; font-size:0.9em"></p>
                </div>
                <div id="configsList" style="max-height:400px; overflow-y:auto; border:1px solid #eee; border-radius:10px;"></div>
                
                <div class="action-buttons">
                    <button class="action-btn btn-copy" onclick="copyAll()">ğŸ“‹ Ú©Ù¾ÛŒ ÛŒÚ©Ø¬Ø§</button>
                    <button class="action-btn btn-download" onclick="downloadTxt()">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ TXT</button>
                    <button class="action-btn btn-sub" onclick="downloadSub()">ğŸ”— Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sources = [
            { name: "Barry-Far", url: "https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/All_Configs_Sub.txt" },
            { name: "Epodonios", url: "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt" },
            { name: "NiREvil", url: "https://raw.githubusercontent.com/NiREvil/vless/main/sub/freedom" },
            { name: "ALIILAPRO", url: "https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/server.txt" },
            { name: "MatinGhanbari", url: "https://raw.githubusercontent.com/MatinGhanbari/V2Ray-Configs/main/All_Configs_Sub.txt" },
            { name: "SoliSpirit", url: "https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/main/All_Configs_Sub.txt" },
            { name: "V2RayRoot", url: "https://raw.githubusercontent.com/V2RayRoot/V2RayConfig/main/v2ray.txt" },
            { name: "HamedCode", url: "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/All_Configs_Sub.txt" },
            { name: "MahdiBland", url: "https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt" },
            { name: "AvenCores", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/All_Configs_Sub.txt" },
            { name: "ShatakVPN", url: "https://raw.githubusercontent.com/shatakvpn/v2ray/main/config" }
        ];

        let finalConfigs = [];

        // 1. Load Sources
        function init() {
            const grid = document.getElementById('sourcesGrid');
            sources.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'source-item selected';
                div.innerHTML = `
                    <div class="source-checkbox">
                        <input type="checkbox" id="src-${idx}" checked onchange="this.parentElement.parentElement.classList.toggle('selected')">
                        <span class="source-name">${src.name}</span>
                    </div>`;
                grid.appendChild(div);
            });
        }

        function toggleAll(state) {
            sources.forEach((_, idx) => {
                const el = document.getElementById(`src-${idx}`);
                el.checked = state;
                if(state) el.parentElement.parentElement.classList.add('selected');
                else el.parentElement.parentElement.classList.remove('selected');
            });
        }

        // 2. Logic: Process & Real Test
        async function startProcess() {
            const limit = parseInt(document.getElementById('outputLimit').value);
            const customText = document.getElementById('customInput').value;
            
            // Collect URLs
            let urls = [];
            sources.forEach((src, idx) => {
                if(document.getElementById(`src-${idx}`).checked) urls.push(src.url);
            });
            
            if(urls.length === 0 && !customText.trim()) return showAlert('Ù‡ÛŒÚ† Ù…Ù†Ø¨Ø¹ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!', 'error');

            // Reset UI
            document.getElementById('resultsArea').style.display = 'none';
            document.getElementById('progressArea').style.display = 'block';
            document.getElementById('startBtn').disabled = true;
            const pBar = document.getElementById('progressFill');
            const pText = document.getElementById('progressText');

            let allConfigs = [];
            
            // Process Custom Links
            if(customText) {
                const customs = customText.split('\n');
                customs.forEach(line => {
                    if(line.startsWith('http')) urls.push(line.trim());
                    else if(line.match(/^(vmess|vless|trojan|ss|hy2)/)) allConfigs.push(line.trim());
                });
            }

            // A. Download Phase
            let processedUrls = 0;
            for(const url of urls) {
                pText.innerText = `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯: ${url.substring(0,30)}...`;
                try {
                    // CORS Proxy Fix
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                    const resp = await fetch(proxyUrl);
                    const text = await resp.text();
                    const decoded = decodeBase64(text);
                    const found = extractConfigs(decoded);
                    allConfigs.push(...found);
                } catch(e) { console.error(e); }
                
                processedUrls++;
                pBar.style.width = `${(processedUrls / urls.length) * 30}%`;
            }

            // Deduplicate
            allConfigs = [...new Set(allConfigs)];
            if(allConfigs.length === 0) {
                showAlert('Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.', 'error');
                document.getElementById('startBtn').disabled = false;
                return;
            }

            // B. Testing Phase (Real Connection)
            pText.innerText = `Ø´Ø±ÙˆØ¹ ØªØ³Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø±ÙˆÛŒ ${allConfigs.length} Ú©Ø§Ù†ÙÛŒÚ¯...`;
            let tested = 0;
            let healthy = [];
            
            // Optimize: Test slightly more than limit to act fast
            const configsToTest = allConfigs.slice(0, Math.min(allConfigs.length, limit * 15));
            const batchSize = 10;

            for(let i=0; i<configsToTest.length; i+=batchSize) {
                const batch = configsToTest.slice(i, i+batchSize);
                const results = await Promise.all(batch.map(checkConnectivity));
                
                results.forEach(res => {
                    if(res.alive) healthy.push(res);
                });

                tested += batch.length;
                const percent = 30 + ((tested / configsToTest.length) * 70);
                pBar.style.width = `${percent}%`;
                pText.innerText = `ØªØ³Øª Ø´Ø¯Ù‡: ${tested} | Ø³Ø§Ù„Ù…: ${healthy.length}`;

                if(healthy.length >= limit * 1.5) break; 
            }

            // Sort & Finish
            healthy.sort((a,b) => a.ping - b.ping);
            finalConfigs = healthy.slice(0, limit);

            renderResults(finalConfigs);
            document.getElementById('progressArea').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
        }

        // Helper: Real Ping Trick (HTTP Connect)
        async function checkConnectivity(config) {
            const start = performance.now();
            let host = '', port = 80;
            
            try {
                if(config.startsWith('vmess')) {
                    const b64 = config.replace('vmess://', '');
                    const json = JSON.parse(decodeBase64(b64));
                    host = json.add; port = json.port;
                } else {
                    const match = config.match(/@([^:]+):(\d+)/) || config.match(/\/\/([^:]+):(\d+)/);
                    if(match) { host = match[1]; port = match[2]; }
                }
            } catch { return { alive: false }; }

            if(!host) return { alive: false };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000); // 2s Timeout
                
                // Try to fetch (Browser blocks raw TCP, so we use HTTP no-cors fetch)
                await fetch(`http://${host}:${port}`, { 
                    mode: 'no-cors', 
                    signal: controller.signal 
                });
                
                clearTimeout(timeoutId);
                const ping = Math.round(performance.now() - start);
                return { alive: true, ping: ping, config: config, host: host };
            } catch (err) {
                // If it aborts -> Timeout (Dead)
                if (err.name === 'AbortError') return { alive: false };
                // If network error instantly -> It means server Refused connection (It is ALIVE but not HTTP)
                const ping = Math.round(performance.now() - start);
                return { alive: true, ping: ping, config: config, host: host };
            }
        }

        // Helpers
        function decodeBase64(str) {
            try { return atob(str.replace(/-/g, '+').replace(/_/g, '/').replace(/\s/g, '')); } 
            catch { return str; }
        }

        function extractConfigs(text) {
            return text.match(/(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g) || [];
        }

        function renderResults(items) {
            const list = document.getElementById('configsList');
            list.innerHTML = '';
            document.getElementById('resultStats').innerText = `${items.length} Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ø±ØªØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.`;

            items.forEach(item => {
                const type = item.config.split('://')[0].toUpperCase();
                let pingClass = item.ping < 500 ? 'fast' : (item.ping < 1000 ? 'medium' : 'slow');
                
                const div = document.createElement('div');
                div.className = 'config-item';
                div.innerHTML = `
                    <div>
                        <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.8em; font-weight:bold">${type}</span>
                        <span style="font-size:0.9em; margin-right:10px; color:#555">${item.host}</span>
                    </div>
                    <div class="config-ping ${pingClass}">${item.ping}ms</div>
                `;
                list.appendChild(div);
            });
        }

        function showAlert(msg, type) {
            const el = document.getElementById('alert');
            el.innerText = msg;
            el.className = `alert alert-${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        // Exports
        function copyAll() {
            const txt = finalConfigs.map(x => x.config).join('\n');
            navigator.clipboard.writeText(txt).then(() => showAlert('Ú©Ù¾ÛŒ Ø´Ø¯!', 'success'));
        }
        function downloadTxt() {
            const txt = finalConfigs.map(x => x.config).join('\n');
            const blob = new Blob([txt], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'Configs.txt'; a.click();
        }
        function downloadSub() {
            const txt = finalConfigs.map(x => x.config).join('\n');
            const blob = new Blob([btoa(txt)], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'Sub.txt'; a.click();
        }

        init();
    </script>
</body>
</html>
