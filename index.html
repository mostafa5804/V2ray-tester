<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ³ØªØ± Ù‡ÙˆØ´Ù…Ù†Ø¯ V2Ray | Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: { primary: '#2563eb', secondary: '#eff6ff', surface: '#ffffff' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; color: #334155; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:active { transform: scale(0.98); }
        .loader-spin { border: 3px solid #e2e8f0; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ØªØ¨â€ŒÙ‡Ø§ */
        .tab-btn { @apply px-3 py-1.5 rounded-full text-xs font-bold transition-colors border border-transparent; }
        .tab-btn.active { @apply bg-blue-600 text-white shadow-md; }
        .tab-btn.inactive { @apply bg-white text-gray-500 border-gray-200 hover:bg-gray-50; }
    </style>
</head>
<body class="pb-36 pt-16">

    <header class="fixed top-0 w-full z-40 bg-white/95 backdrop-blur-md border-b border-gray-200 h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-9 h-9 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center shadow-inner">
                <i class="fas fa-bolt text-lg"></i>
            </div>
            <div>
                <h1 class="font-black text-gray-800 text-lg leading-tight tracking-tight">ØªØ³ØªØ± Ú©Ø§Ù†ÙÛŒÚ¯</h1>
                <p class="text-[10px] text-gray-400 font-mono">v3.0 Pro</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-blue-50 hover:text-blue-600 transition">
                <i class="fas fa-sync-alt text-xs"></i>
            </button>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-5">

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                    <i class="fas fa-server text-blue-500"></i> Ù…Ù†Ø§Ø¨Ø¹ (Deep Select)
                </h2>
                <div class="flex gap-1 bg-gray-100 p-1 rounded-lg">
                    <button onclick="toggleSources(true)" class="px-3 py-1 text-[10px] font-bold rounded-md bg-white text-blue-600 shadow-sm transition">Ù‡Ù…Ù‡</button>
                    <button onclick="toggleSources(false)" class="px-3 py-1 text-[10px] font-bold rounded-md text-gray-500 hover:bg-white/50 transition">Ù‡ÛŒÚ†</button>
                </div>
            </div>
            
            <div id="sourcesGrid" class="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto custom-scroll p-1">
                </div>
        </section>

        <div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-100 overflow-hidden">
            <textarea id="customInput" class="w-full h-14 p-3 text-xs bg-transparent outline-none placeholder-gray-400 font-mono dir-ltr resize-none" placeholder="Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯ (vless://, vmess://, ...)"></textarea>
        </div>

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4">
            <div class="flex items-center justify-between">
                <span class="text-xs font-bold text-gray-600 flex items-center gap-1"><i class="fas fa-filter text-gray-400"></i> ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÙˆØ¬ÛŒ</span>
                <span id="limitDisplay" class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">20</span>
            </div>
            <input type="range" id="limitInput" min="5" max="200" value="20" class="w-full h-1.5 bg-gray-100 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="document.getElementById('limitDisplay').innerText = this.value">
            
            <div class="flex items-center gap-3 pt-2">
                <label class="flex-1 flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-100 cursor-pointer select-none">
                    <input type="checkbox" id="deepCheck" class="w-4 h-4 accent-blue-600 rounded">
                    <span class="text-[10px] font-bold text-gray-600">ØªØ³Øª Ø¯Ù‚ÛŒÙ‚ WS (Ú©Ù†Ø¯ØªØ±)</span>
                </label>
                <label class="flex-1 flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-100 cursor-pointer select-none">
                    <input type="checkbox" id="dedup" class="w-4 h-4 accent-blue-600 rounded" checked>
                    <span class="text-[10px] font-bold text-gray-600">Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                </label>
            </div>
        </section>

        <button id="startBtn" onclick="startProcess()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex justify-center items-center gap-2 text-base group">
            <span>Ø´Ø±ÙˆØ¹ Ø¢Ù†Ø§Ù„ÛŒØ² Ùˆ ØªØ³Øª</span>
            <i class="fas fa-rocket group-hover:translate-x-1 transition-transform"></i>
        </button>

        <div id="statusArea" class="hidden flex flex-col items-center py-6">
            <div class="loader-spin mb-3"></div>
            <p id="statusText" class="text-xs font-bold text-gray-500 animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø·...</p>
            <div class="w-64 bg-gray-200 rounded-full h-1.5 mt-4 overflow-hidden">
                <div id="progressBar" class="bg-blue-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-4">
            
            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="filterResults('all')" class="tab-btn active" id="filter-all">Ù‡Ù…Ù‡ (<span id="count-all">0</span>)</button>
                <button onclick="filterResults('vless')" class="tab-btn inactive" id="filter-vless">VLESS</button>
                <button onclick="filterResults('vmess')" class="tab-btn inactive" id="filter-vmess">VMess</button>
                <button onclick="filterResults('reality')" class="tab-btn inactive" id="filter-reality">Reality</button>
            </div>

            <div id="cardsContainer" class="space-y-3"></div>
        </div>

    </main>

    <div id="actionBar" class="hidden fixed bottom-6 left-0 w-full px-4 z-40">
        <div class="max-w-xl mx-auto glass-panel p-2 rounded-2xl shadow-2xl flex gap-2">
            <button onclick="copyAll()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-md active:bg-blue-700 transition flex flex-col items-center justify-center leading-none gap-1">
                <span class="text-xs opacity-80">COPY</span>
                <span>Ú©Ù¾ÛŒ Ø³Ø§Ù„Ù…â€ŒÙ‡Ø§</span>
            </button>
            <button onclick="downloadSub()" class="flex-1 bg-white text-gray-700 border border-gray-200 py-3 rounded-xl font-bold text-sm shadow-sm hover:bg-gray-50 transition flex flex-col items-center justify-center leading-none gap-1">
                <span class="text-xs opacity-60">FILE</span>
                <span>Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</span>
            </button>
        </div>
    </div>

    <div id="qrModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onclick="closeQr()">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-2xl transform transition-all scale-95" onclick="event.stopPropagation()">
            <h3 class="font-bold text-gray-800 mb-4">Ø§Ø³Ú©Ù† Ø¬Ù‡Øª Ø§ØªØµØ§Ù„</h3>
            <div id="qrPlace" class="flex justify-center mb-4 bg-white p-2 rounded-xl border border-gray-100"></div>
            <div class="text-xs text-gray-500 font-mono break-all mb-4 line-clamp-2" id="qrTextLink"></div>
            <button onclick="closeQr()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ù…Ù†Ø§Ø¨Ø¹ (Ø¨Ø±ÙˆØ² Ø´Ø¯Ù‡) ---
        const sources = [
            { name: "AvenCores 1", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/1.txt" },
            { name: "AvenCores 2", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/2.txt" },
            { name: "AvenCores 3", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/3.txt" },
            { name: "ShatakVPN", url: "https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/main/configs/all.txt" },
            { name: "HamedCode", url: "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/sub/vless.txt" },
            { name: "V2RayRoot", url: "https://raw.githubusercontent.com/V2RayRoot/V2RayConfig/main/Config/vless.txt" },
            { name: "SoliSpirit", url: "https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/refs/heads/main/all_configs.txt" },
            { name: "ALIILAPRO", url: "https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/server.txt" },
            { name: "MatinGhanbari", url: "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/all_sub.txt" },
            { name: "Barry-Far", url: "https://raw.githubusercontent.com/barry-far/V2ray-config/main/All_Configs_base64_Sub.txt" },
            { name: "Epodonios", url: "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt" }
        ];

        let validConfigs = [];
        let displayedConfigs = [];

        // --- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        function renderSources() {
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = '';
            sources.forEach((src, idx) => {
                grid.innerHTML += `
                    <label class="cursor-pointer relative group block">
                        <input type="checkbox" value="${src.url}" class="source-checkbox hidden" checked>
                        <div class="source-card bg-gray-50 rounded-xl p-3 flex items-center gap-3 select-none hover:bg-white">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center font-bold text-xs shadow-sm">${idx + 1}</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-xs text-gray-700 truncate">${src.name}</div>
                                <div class="text-[9px] text-gray-400 truncate font-mono opacity-70">${src.url.substring(8, 35)}...</div>
                            </div>
                            <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center check-circle transition-colors group-hover:border-blue-300">
                                <div class="w-2.5 h-2.5 rounded-full bg-blue-500 opacity-0 check-icon transition-opacity"></div>
                            </div>
                        </div>
                    </label>
                `;
            });
        }

        // --- Ø§Ø³ØªØ§ÛŒÙ„ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ ---
        const style = document.createElement('style');
        style.textContent = `.source-checkbox:checked + .source-card .check-circle { border-color: #3b82f6; } .source-checkbox:checked + .source-card .check-icon { opacity: 1; } .source-checkbox:checked + .source-card { background: white; border-color: #3b82f6; box-shadow: 0 4px 10px -2px rgba(59, 130, 246, 0.15); }`;
        document.head.appendChild(style);

        function toggleSources(state) {
            document.querySelectorAll('.source-checkbox').forEach(cb => cb.checked = state);
        }

        // --- Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§ØµÙ„ÛŒ ---
        async function startProcess() {
            const selectedUrls = Array.from(document.querySelectorAll('.source-checkbox:checked')).map(cb => cb.value);
            const customLinks = document.getElementById('customInput').value.trim();
            const limit = parseInt(document.getElementById('limitInput').value);
            const deepCheck = document.getElementById('deepCheck').checked;
            const dedup = document.getElementById('dedup').checked;

            if (selectedUrls.length === 0 && !customLinks) return alert("Ù„Ø·ÙØ§ Ù…Ù†Ø¨Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!");

            // UI Reset
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('actionBar').classList.add('hidden');
            document.getElementById('cardsContainer').innerHTML = '';
            validConfigs = [];

            const pBar = document.getElementById('progressBar');
            const pText = document.getElementById('statusText');

            let allConfigs = [];

            // 1. Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ù†Ø§Ø¨Ø¹
            let downloaded = 0;
            const totalSources = selectedUrls.length + (customLinks ? 1 : 0);

            if (customLinks) {
                const lines = customLinks.split('\n');
                lines.forEach(line => {
                    if (line.match(/^(vmess|vless|trojan|ss|hy2)/)) allConfigs.push(line.trim());
                });
            }

            for (const url of selectedUrls) {
                pText.innerText = `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…Ù†Ø§Ø¨Ø¹ (${downloaded}/${selectedUrls.length})...`;
                pBar.style.width = `${(downloaded / totalSources) * 30}%`;
                try {
                    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const res = await fetch(proxy);
                    const text = await res.text();
                    const decoded = smartDecode(text);
                    const extracted = extractConfigs(decoded);
                    allConfigs.push(...extracted);
                } catch {}
                downloaded++;
            }

            // 2. Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒ (Ù‡ÙˆØ´Ù…Ù†Ø¯)
            if (dedup) {
                pText.innerText = "Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯...";
                const uniqueMap = new Map();
                allConfigs.forEach(conf => {
                    const details = parseConfigDetails(conf);
                    if (details) {
                        const key = `${details.ip}:${details.port}`; // Ú©Ù„ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯: Ø¢ÛŒâ€ŒÙ¾ÛŒ Ùˆ Ù¾ÙˆØ±Øª
                        if (!uniqueMap.has(key)) uniqueMap.set(key, conf);
                    }
                });
                allConfigs = Array.from(uniqueMap.values());
            } else {
                allConfigs = [...new Set(allConfigs)];
            }

            if (allConfigs.length === 0) {
                alert("Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!");
                location.reload();
                return;
            }

            // 3. ØªØ³Øª Ø§ØªØµØ§Ù„
            pText.innerText = `ØªØ³Øª Ø§ØªØµØ§Ù„ ${allConfigs.length} Ú©Ø§Ù†ÙÛŒÚ¯...`;
            let checked = 0;
            const maxChecks = Math.min(allConfigs.length, limit * (deepCheck ? 3 : 5));
            const batchSize = deepCheck ? 5 : 15;

            for (let i = 0; i < maxChecks; i += batchSize) {
                const batch = allConfigs.slice(i, i + batchSize);
                const promises = batch.map(conf => checkConnectivity(conf, deepCheck));
                const results = await Promise.all(promises);

                results.forEach(res => {
                    if (res.alive) validConfigs.push(res);
                });

                checked += batch.length;
                const progress = 30 + ((checked / maxChecks) * 70);
                pBar.style.width = `${progress}%`;
                pText.innerText = `ØªØ³Øª Ø´Ø¯Ù‡: ${checked} | Ø³Ø§Ù„Ù…: ${validConfigs.length}`;

                if (validConfigs.length >= limit * 1.2) break;
            }

            // 4. Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
            validConfigs.sort((a, b) => a.ping - b.ping);
            displayedConfigs = validConfigs.slice(0, limit);
            
            filterResults('all'); // Ø±Ù†Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ‡
            
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('actionBar').classList.remove('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').innerText = "ØªØ³Øª Ù…Ø¬Ø¯Ø¯";
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---

        function smartDecode(str) {
            try {
                str = str.trim();
                if (str.includes('vmess://') || str.includes('vless://')) return str;
                return atob(str.replace(/-/g, '+').replace(/_/g, '/').replace(/\s/g, ''));
            } catch { return str; }
        }

        function extractConfigs(text) {
            return text.match(/(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g) || [];
        }

        function parseConfigDetails(config) {
            try {
                let ip, port, type, name = 'Config';
                if (config.startsWith('vmess')) {
                    const b64 = config.replace('vmess://', '');
                    const json = JSON.parse(atob(b64));
                    ip = json.add; port = json.port; type = 'vmess'; name = json.ps || '';
                } else {
                    const match = config.match(/^(.*?):\/\/(?:.*?@)?(.*?):(\d+)/);
                    if (match) {
                        type = match[1]; ip = match[2]; port = match[3];
                        name = decodeURIComponent(config.split('#')[1] || '');
                    }
                }
                // ØªØ´Ø®ÛŒØµ Ù¾Ø±Ú†Ù… Ø§Ø² Ù†Ø§Ù…
                let flag = "ğŸ³ï¸";
                const flagMatch = name.match(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/);
                if (flagMatch) flag = flagMatch[0];
                
                return { ip, port, type, name, flag };
            } catch { return null; }
        }

        async function checkConnectivity(config, deep) {
            const start = Date.now();
            const details = parseConfigDetails(config);
            if (!details) return { alive: false };

            // ØªØ³Øª Ù¾ÙˆØ±Øª (Ø³Ø±ÛŒØ¹)
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 2000);
                
                // ØªØ±ÙÙ†Ø¯ fetch no-cors
                await fetch(`http://${details.ip}:${details.port}`, { 
                    mode: 'no-cors', 
                    signal: controller.signal 
                });
                clearTimeout(timeout);
                
                // Ø§Ú¯Ø± WS Ø¨Ø§Ø´Ø¯ Ùˆ ØªØ³Øª Ø¹Ù…ÛŒÙ‚ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŒ ØªØ³Øª Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ Ùˆ Ø³Ø±Ø¹ØªØŒ Ù…ÙˆÙÙ‚ÛŒØª fetch Ø±Ø§ Ù…Ù„Ø§Ú© Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                
                return { alive: true, ping: Date.now() - start, config, details };
            } catch (err) {
                if (err.name === 'AbortError') return { alive: false };
                // Network Error Ø³Ø±ÛŒØ¹ ÛŒØ¹Ù†ÛŒ Ù¾ÙˆØ±Øª Ø¨Ø§Ø² Ø§Ø³Øª (RST)
                return { alive: true, ping: Date.now() - start, config, details };
            }
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ùˆ ÙÛŒÙ„ØªØ± ---

        function filterResults(type) {
            // Ø¢Ù¾Ø¯ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            document.getElementById(`filter-${type}`).className = 'tab-btn active';

            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            let filtered = displayedConfigs;
            if (type !== 'all') {
                if (type === 'reality') {
                    filtered = displayedConfigs.filter(c => c.config.includes('security=reality') || c.config.includes('pbk='));
                } else {
                    filtered = displayedConfigs.filter(c => c.details.type === type);
                }
            }

            document.getElementById('count-all').innerText = displayedConfigs.length;

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 text-sm py-10">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>`;
                return;
            }

            filtered.forEach(item => {
                const d = item.details;
                const pingColor = item.ping < 500 ? 'text-green-600 bg-green-50' : (item.ping < 1000 ? 'text-yellow-600 bg-yellow-50' : 'text-orange-600 bg-orange-50');
                
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-100 rounded-2xl p-3 flex justify-between items-center shadow-sm hover:shadow-md card-hover group';
                card.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden w-full">
                        <div class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center text-xl shadow-inner shrink-0">
                            ${d.flag}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="bg-blue-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider">${d.type}</span>
                                <span class="font-bold text-xs text-gray-700 truncate">${d.name || 'Config'}</span>
                            </div>
                            <div class="flex items-center gap-2 text-[10px] text-gray-400 font-mono">
                                <span class="truncate max-w-[120px]">${d.ip}:${d.port}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="font-mono text-xs font-bold px-2 py-0.5 rounded-md ${pingColor}">${item.ping}ms</span>
                            <button onclick="showQr('${encodeURIComponent(item.config)}')" class="text-gray-400 hover:text-blue-500 transition">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- QR Code Modal ---
        function showQr(config) {
            config = decodeURIComponent(config);
            const modal = document.getElementById('qrModal');
            const place = document.getElementById('qrPlace');
            const textLink = document.getElementById('qrTextLink');
            
            place.innerHTML = '';
            textLink.innerText = config.substring(0, 50) + '...';
            
            new QRCode(place, {
                text: config,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });
            
            modal.classList.remove('hidden');
        }

        function closeQr() {
            document.getElementById('qrModal').classList.add('hidden');
        }

        // --- Ú©Ù¾ÛŒ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ ---
        function copyAll() {
            const txt = displayedConfigs.map(c => c.config).join('\n');
            navigator.clipboard.writeText(txt).then(() => alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!'));
        }

        function downloadSub() {
            const txt = displayedConfigs.map(c => c.config).join('\n');
            const blob = new Blob([btoa(txt)], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Sub_${Date.now()}.txt`;
            link.click();
        }

        // Ø§Ø¬Ø±Ø§
        renderSources();
    </script>
</body>
</html>
