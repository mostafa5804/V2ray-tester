<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پالایشگر هوشمند کانفیگ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; color: #1f2937; -webkit-tap-highlight-color: transparent; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .checkbox-wrapper input:checked + div { background-color: #e0f2fe; border-color: #0ea5e9; color: #0284c7; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* استایل اسکرول بار زیبا */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="pb-32">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-2xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fas fa-filter text-sky-600 text-xl"></i>
                <h1 class="font-bold text-lg text-gray-800">پالایشگر کانفیگ</h1>
            </div>
            <span class="text-xs font-mono bg-gray-100 text-gray-500 px-2 py-1 rounded-lg">Web V4.0</span>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 pt-6 space-y-6">

        <section class="bg-white rounded-2xl p-5 card-shadow space-y-4">
            <div class="flex items-center gap-2 text-sky-700 font-bold border-b pb-2">
                <i class="fas fa-sliders-h"></i> تنظیمات ورودی
            </div>

            <div>
                <label class="block text-sm text-gray-500 mb-2">لینک‌های اشتراک دستی (اختیاری)</label>
                <textarea id="customLinks" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-xs font-mono focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none h-20 placeholder-gray-400 dir-ltr" placeholder="https://example.com/sub..."></textarea>
            </div>

            <div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">تعداد کانفیگ خروجی:</span>
                    <span id="limitVal" class="font-bold text-sky-600">20</span>
                </div>
                <input type="range" id="outputLimit" min="5" max="200" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-sky-500" oninput="document.getElementById('limitVal').innerText = this.value">
            </div>
        </section>

        <section class="bg-white rounded-2xl p-5 card-shadow space-y-4">
            <div class="flex justify-between items-center border-b pb-2">
                <div class="flex items-center gap-2 text-sky-700 font-bold">
                    <i class="fas fa-box-open"></i> منابع پیشنهادی
                </div>
                <div class="flex gap-2 text-xs">
                    <button onclick="toggleAll(true)" class="text-sky-600 hover:bg-sky-50 px-2 py-1 rounded transition">انتخاب همه</button>
                    <span class="text-gray-300">|</span>
                    <button onclick="toggleAll(false)" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded transition">حذف همه</button>
                </div>
            </div>

            <div id="sourcesGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-1">
                </div>
        </section>

        <button onclick="startProcess()" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-sky-200 transition-transform active:scale-95 flex justify-center items-center gap-2 text-lg">
            <i class="fas fa-rocket"></i> شروع پردازش و تست
        </button>

        <div id="statusArea" class="hidden text-center space-y-2">
            <div class="inline-block loader"></div>
            <p id="statusText" class="text-sm text-gray-500 animate-pulse">در حال آماده‌سازی...</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 mt-2">
                <div id="progressBar" class="bg-sky-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <section id="resultsSection" class="hidden bg-white rounded-2xl p-5 card-shadow space-y-4">
            <div class="flex justify-between items-center border-b pb-2">
                <span class="font-bold text-emerald-600"><i class="fas fa-check-circle"></i> کانفیگ‌های سالم</span>
                <span id="resultCount" class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full font-bold">0</span>
            </div>
            
            <div id="cardsContainer" class="space-y-3">
                </div>
        </section>

    </main>

    <div id="actionBar" class="hidden fixed bottom-4 left-0 w-full px-4 z-40">
        <div class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md p-3 rounded-2xl shadow-2xl border border-gray-200 flex gap-2 overflow-x-auto">
            <button onclick="copyConfigs()" class="flex-1 min-w-[120px] bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-md transition flex flex-col items-center justify-center gap-1">
                <i class="fas fa-copy text-lg"></i> کپی یکجا
            </button>
            <button onclick="downloadTxt()" class="flex-1 min-w-[120px] bg-sky-500 hover:bg-sky-600 text-white py-3 rounded-xl font-bold text-sm shadow-md transition flex flex-col items-center justify-center gap-1">
                <i class="fas fa-file-alt text-lg"></i> دانلود TXT
            </button>
            <button onclick="downloadSub()" class="flex-1 min-w-[120px] bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold text-sm shadow-md transition flex flex-col items-center justify-center gap-1">
                <i class="fas fa-link text-lg"></i> ساب لینک
            </button>
        </div>
    </div>

    <script>
        // --- لیست منابع (لینک‌های خام Raw) ---
        const sources = [
            { name: "Barry-Far", url: "https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/All_Configs_Sub.txt" },
            { name: "Epodonios", url: "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt" },
            { name: "NiREvil", url: "https://raw.githubusercontent.com/NiREvil/vless/main/sub/vless" },
            { name: "ALIILAPRO", url: "https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/server.txt" },
            { name: "MatinGhanbari", url: "https://raw.githubusercontent.com/MatinGhanbari/V2Ray-Configs/main/All_Configs_Sub.txt" },
            { name: "SoliSpirit", url: "https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/main/All_Configs_Sub.txt" },
            { name: "V2RayRoot", url: "https://raw.githubusercontent.com/V2RayRoot/V2RayConfig/main/v2ray.txt" },
            { name: "HamedCode", url: "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/All_Configs_Sub.txt" },
            { name: "Bulk-Xray", url: "https://raw.githubusercontent.com/Epodonios/bulk-xray-v2ray-vless-vmess-configs/main/All_Configs_Sub.txt" },
            { name: "MahdiBland", url: "https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt" },
            { name: "AvenCores", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/All_Configs_Sub.txt" },
            { name: "ShatakVPN", url: "https://raw.githubusercontent.com/shatakvpn/v2ray/main/config" }
        ];

        let finalConfigs = []; // نگهداری کانفیگ‌های نهایی

        // 1. ساخت چک‌باکس‌ها
        function renderSources() {
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = '';
            sources.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'checkbox-wrapper cursor-pointer';
                div.innerHTML = `
                    <label class="cursor-pointer block">
                        <input type="checkbox" value="${src.url}" class="hidden peer" checked>
                        <div class="border border-gray-200 rounded-xl p-3 flex items-center gap-3 bg-gray-50 hover:bg-gray-100 transition peer-checked:bg-sky-50 peer-checked:border-sky-400 peer-checked:text-sky-700">
                            <i class="fab fa-github text-lg"></i>
                            <span class="font-bold text-sm select-none">${src.name}</span>
                            <i class="fas fa-check-circle ml-auto opacity-0 peer-checked:opacity-100 text-sky-500"></i>
                        </div>
                    </label>
                `;
                grid.appendChild(div);
            });
        }

        function toggleAll(state) {
            document.querySelectorAll('#sourcesGrid input[type="checkbox"]').forEach(cb => cb.checked = state);
        }

        // 2. شروع پردازش
        async function startProcess() {
            const selectedSources = Array.from(document.querySelectorAll('#sourcesGrid input:checked')).map(cb => cb.value);
            const customLinks = document.getElementById('customLinks').value.trim().split('\n').filter(l => l);
            const limit = parseInt(document.getElementById('outputLimit').value);

            if (selectedSources.length === 0 && customLinks.length === 0) {
                alert("لطفاً حداقل یک منبع یا لینک دستی وارد کنید!");
                return;
            }

            // ریست کردن UI
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('actionBar').classList.add('hidden');
            document.getElementById('cardsContainer').innerHTML = '';
            
            const statusText = document.getElementById('statusText');
            const progressBar = document.getElementById('progressBar');
            
            let allRawConfigs = [];
            let totalLinks = selectedSources.length + customLinks.length;
            let processedLinks = 0;

            // الف) دانلود لینک‌ها
            const urlsToFetch = [...selectedSources, ...customLinks];
            
            for (const url of urlsToFetch) {
                if (!url) continue;
                statusText.innerText = `در حال دریافت: ${url.substring(0, 30)}...`;
                try {
                    // استفاده از پروکسی برای دور زدن CORS
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const text = await response.text();
                    const decoded = decodeBase64(text);
                    const extracted = extractConfigs(decoded);
                    allRawConfigs.push(...extracted);
                } catch (e) {
                    console.log(`Error fetching ${url}:`, e);
                }
                processedLinks++;
                progressBar.style.width = `${(processedLinks / totalLinks) * 30}%`;
            }

            // حذف تکراری‌ها
            allRawConfigs = [...new Set(allRawConfigs)];
            statusText.innerText = `پیدا شد: ${allRawConfigs.length} کانفیگ. شروع تست سرعت...`;

            if (allRawConfigs.length === 0) {
                alert("هیچ کانفیگی پیدا نشد!");
                document.getElementById('statusArea').classList.add('hidden');
                return;
            }

            // ب) تست سرعت (همزمان)
            let tested = 0;
            let aliveConfigs = [];
            
            // بهینه‌سازی: فقط تعداد بیشتری از لیمیت را تست کنیم نه همه را (مثلا ۳ برابر لیمیت)
            // تا سرعت بالاتر برود.
            const configsToTest = allRawConfigs.slice(0, Math.min(allRawConfigs.length, limit * 15)); 

            const batchSize = 20; // تست 20 تا 20 تا
            for (let i = 0; i < configsToTest.length; i += batchSize) {
                const batch = configsToTest.slice(i, i + batchSize);
                const promises = batch.map(conf => checkConnectivity(conf));
                
                const results = await Promise.all(promises);
                
                results.forEach(res => {
                    if (res.alive) aliveConfigs.push(res);
                });

                tested += batch.length;
                let progress = 30 + ((tested / configsToTest.length) * 70);
                progressBar.style.width = `${progress}%`;
                statusText.innerText = `تست شده: ${tested} / ${configsToTest.length} | سالم: ${aliveConfigs.length}`;
                
                // اگر به اندازه کافی کانفیگ سالم پیدا کردیم، متوقف شویم
                if (aliveConfigs.length >= limit * 1.5) break; 
            }

            // ج) مرتب‌سازی و نمایش
            aliveConfigs.sort((a, b) => a.ping - b.ping);
            finalConfigs = aliveConfigs.slice(0, limit).map(x => x.config);

            renderResults(aliveConfigs.slice(0, limit));
            
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('actionBar').classList.remove('hidden');
            document.getElementById('resultCount').innerText = finalConfigs.length;
        }

        // --- توابع کمکی ---

        function decodeBase64(str) {
            try {
                return atob(str.replace(/-/g, '+').replace(/_/g, '/').replace(/\s/g, ''));
            } catch { return str; }
        }

        function extractConfigs(text) {
            return text.match(/(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g) || [];
        }

        async function checkConnectivity(config) {
            const start = performance.now();
            let host = '', port = 80;
            try {
                if (config.startsWith('vmess')) {
                   const d = JSON.parse(atob(config.split('://')[1]));
                   host = d.add; port = d.port;
                } else {
                   const match = config.match(/@([^:]+):(\d+)/) || config.match(/\/\/([^:]+):(\d+)/);
                   if(match) { host = match[1]; port = match[2]; }
                }
            } catch { return { alive: false }; }

            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 1500); // تایم‌اوت 1.5 ثانیه
                await fetch(`http://${host}:${port}`, { mode: 'no-cors', signal: controller.signal });
                clearTimeout(id);
                return { alive: true, ping: Math.round(performance.now() - start), config: config };
            } catch (err) {
                if (err.name === 'AbortError') return { alive: false };
                // در حالت no-cors اگر ارور نتورک سریع بدهد یعنی سرور هست ولی اجازه دسترسی نمیده
                return { alive: true, ping: Math.round(performance.now() - start), config: config };
            }
        }

        function renderResults(items) {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            items.forEach(item => {
                let type = item.config.split('://')[0].toUpperCase();
                let name = decodeURIComponent(item.config.split('#')[1] || 'Config');
                
                // تعیین رنگ پینگ
                let pingColor = item.ping < 500 ? 'text-emerald-500' : (item.ping < 1000 ? 'text-yellow-500' : 'text-orange-500');

                const div = document.createElement('div');
                div.className = 'bg-gray-50 border border-gray-200 rounded-xl p-3 flex justify-between items-center hover:bg-white hover:shadow-md transition';
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="bg-white p-2 rounded-lg border border-gray-100 shadow-sm text-sky-600 font-bold text-xs w-14 text-center">
                            ${type}
                        </div>
                        <div class="truncate">
                            <div class="font-bold text-gray-700 text-sm truncate max-w-[150px] sm:max-w-xs">${name}</div>
                            <div class="text-[10px] text-gray-400 font-mono">${item.config.substring(0, 30)}...</div>
                        </div>
                    </div>
                    <div class="font-mono text-xs font-bold ${pingColor}">
                        ${item.ping}ms
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- دکمه‌های خروجی ---
        
        function copyConfigs() {
            if (!finalConfigs.length) return;
            navigator.clipboard.writeText(finalConfigs.join('\n')).then(() => alert('✅ کپی شد!'));
        }

        function downloadTxt() {
            if (!finalConfigs.length) return;
            const blob = new Blob([finalConfigs.join('\n')], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Clean_Configs.txt';
            link.click();
        }

        function downloadSub() {
            if (!finalConfigs.length) return;
            const text = finalConfigs.join('\n');
            const b64 = btoa(text); // تبدیل به بیس 64
            const blob = new Blob([b64], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Subscription.txt';
            link.click();
        }

        // اجرا در شروع
        renderSources();
    </script>
</body>
</html>
