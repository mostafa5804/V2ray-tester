<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تستر هوشمند کانفیگ</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: {
                        primary: '#3b82f6', // آبی
                        secondary: '#eff6ff', 
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .source-card { transition: all 0.2s ease; border: 1px solid #e2e8f0; }
        .source-checkbox:checked + .source-card {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #1d4ed8;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
        }
        .source-checkbox:checked + .source-card .check-icon { opacity: 1; transform: scale(1); }
    </style>
</head>
<body class="pb-32">

    <header class="bg-white/90 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50 h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-network-wired"></i>
            </div>
            <h1 class="font-bold text-gray-800 text-lg">تستر کانفیگ</h1>
        </div>
        <div class="text-xs font-mono bg-gray-100 text-gray-500 px-2 py-1 rounded">Update: New Sources</div>
    </header>

    <main class="max-w-lg mx-auto p-4 space-y-5">

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                    <i class="fas fa-server text-blue-500"></i> منابع انتخابی شما
                </h2>
                <div class="flex gap-2">
                    <button onclick="toggleSources(true)" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100">همه</button>
                    <button onclick="toggleSources(false)" class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded hover:bg-gray-100">هیچکدام</button>
                </div>
            </div>
            
            <div id="sourcesGrid" class="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto custom-scroll p-1">
                </div>
        </section>

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">لینک دستی (اختیاری)</label>
                <textarea id="customInput" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-xs font-mono focus:border-blue-500 outline-none h-16 placeholder-gray-400 dir-ltr" placeholder="vless://..."></textarea>
            </div>

            <div class="bg-blue-50/50 rounded-xl p-3 border border-blue-100">
                <div class="flex justify-between text-xs mb-2">
                    <span class="text-gray-600">تعداد خروجی:</span>
                    <span id="limitDisplay" class="font-bold text-blue-600">20</span>
                </div>
                <input type="range" id="limitInput" min="5" max="200" value="20" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="document.getElementById('limitDisplay').innerText = this.value">
                
                <div class="flex justify-between text-xs mt-3 mb-2">
                    <span class="text-gray-600">تایم‌اوت (ثانیه):</span>
                    <span id="timeoutDisplay" class="font-bold text-blue-600">2.0</span>
                </div>
                <input type="range" id="timeoutInput" min="0.5" max="5" step="0.5" value="2.0" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="document.getElementById('timeoutDisplay').innerText = this.value">
            </div>
        </section>

        <button id="startBtn" onclick="startProcess()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition-transform active:scale-95 flex justify-center items-center gap-2 text-base">
            <span>شروع تست واقعی</span>
            <i class="fas fa-play text-xs"></i>
        </button>

        <div id="statusArea" class="hidden text-center py-4">
            <div class="loader mx-auto mb-3"></div>
            <p id="statusText" class="text-xs text-gray-500 animate-pulse">در حال اتصال...</p>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3 overflow-hidden">
                <div id="progressBar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-3">
            <div class="flex justify-between items-center px-1">
                <h3 class="font-bold text-gray-700 text-sm">نتایج (<span id="countVal">0</span>)</h3>
                <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">سالم</span>
            </div>
            
            <div id="cardsContainer" class="space-y-2"></div>
        </div>

    </main>

    <div id="actionBar" class="hidden fixed bottom-5 left-0 w-full px-4 z-40">
        <div class="max-w-lg mx-auto bg-white border border-gray-200 p-2 rounded-2xl shadow-xl flex gap-2">
            <button onclick="copyAll()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-md active:bg-blue-700 transition">
                کپی یکجا
            </button>
            <button onclick="downloadSub()" class="flex-1 bg-white text-gray-700 border border-gray-200 py-3 rounded-xl font-bold text-sm shadow-sm hover:bg-gray-50 transition">
                دانلود فایل
            </button>
        </div>
    </div>

    <script>
        // ✅ لیست جدید و دقیق طبق درخواست شما
        const sources = [
            { name: "AvenCores - Mirror 1", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/1.txt" },
            { name: "AvenCores - Mirror 2", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/2.txt" },
            { name: "AvenCores - Mirror 3", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/3.txt" },
            { name: "namira", url: "https://www.namira.dev/api/subscription" },
            { name: "ShatakVPN - All", url: "https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/main/configs/all.txt" },
            { name: "HamedCode - Vless", url: "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/sub/vless.txt" },
            { name: "V2RayRoot - Vless", url: "https://raw.githubusercontent.com/V2RayRoot/V2RayConfig/main/Config/vless.txt" },
            { name: "SoliSpirit - All", url: "https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/main/all_configs.txt" },
            { name: "ALIILAPRO - Server", url: "https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/server.txt" },
            { name: "MatinGhanbari - All", url: "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/all_sub.txt" },
            { name: "Barry-Far - Base64", url: "https://raw.githubusercontent.com/barry-far/V2ray-config/main/All_Configs_base64_Sub.txt" },
            { name: "Epodonios - All", url: "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt" }
        ];

        let validConfigs = [];

        function renderSources() {
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = '';
            sources.forEach((src, idx) => {
                grid.innerHTML += `
                    <label class="cursor-pointer relative group">
                        <input type="checkbox" value="${src.url}" class="source-checkbox hidden" checked>
                        <div class="source-card bg-gray-50 rounded-xl p-3 flex items-center gap-3 select-none">
                            <span class="w-2 h-2 rounded-full bg-gray-300 status-dot group-hover:bg-blue-300 transition"></span>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-xs text-gray-700 truncate">${src.name}</div>
                                <div class="text-[9px] text-gray-400 truncate">${src.url.split('/').pop()}</div>
                            </div>
                            <i class="fas fa-check-circle text-blue-500 opacity-0 check-icon text-lg transition-transform scale-50"></i>
                        </div>
                    </label>
                `;
            });
        }

        function toggleSources(state) {
            document.querySelectorAll('.source-checkbox').forEach(cb => cb.checked = state);
        }

        async function startProcess() {
            const selectedUrls = Array.from(document.querySelectorAll('.source-checkbox:checked')).map(cb => cb.value);
            const customLinks = document.getElementById('customInput').value.trim();
            const limit = parseInt(document.getElementById('limitInput').value);
            const timeout = parseFloat(document.getElementById('timeoutInput').value) * 1000;

            if (selectedUrls.length === 0 && !customLinks) {
                alert("لطفاً حداقل یک منبع انتخاب کنید!");
                return;
            }

            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('actionBar').classList.add('hidden');
            document.getElementById('cardsContainer').innerHTML = '';
            validConfigs = [];

            const pBar = document.getElementById('progressBar');
            const pText = document.getElementById('statusText');

            let allConfigs = [];

            if (customLinks) {
                const lines = customLinks.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('http')) selectedUrls.push(line.trim());
                    else if (line.match(/^(vmess|vless|trojan|ss|hy2)/)) allConfigs.push(line.trim());
                });
            }

            let downloaded = 0;
            for (const url of selectedUrls) {
                pText.innerText = `دانلود منابع (${downloaded + 1}/${selectedUrls.length})...`;
                pBar.style.width = `${((downloaded + 1) / selectedUrls.length) * 30}%`;
                
                try {
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const res = await fetch(proxyUrl);
                    const text = await res.text();
                    
                    const decoded = smartDecode(text);
                    const extracted = extractConfigs(decoded);
                    allConfigs.push(...extracted);
                } catch (e) { console.log(e); }
                downloaded++;
            }

            allConfigs = [...new Set(allConfigs)];
            
            if (allConfigs.length === 0) {
                alert("هیچ کانفیگی یافت نشد! (شاید منابع در دسترس نیستند)");
                window.location.reload();
                return;
            }

            pText.innerText = `تست اتصال ${allConfigs.length} کانفیگ...`;
            
            const maxChecks = Math.min(allConfigs.length, limit * 6);
            let checked = 0;
            const batchSize = 10;

            for (let i = 0; i < maxChecks; i += batchSize) {
                const batch = allConfigs.slice(i, i + batchSize);
                const promises = batch.map(conf => checkConnectivity(conf, timeout));
                const results = await Promise.all(promises);

                results.forEach(res => {
                    if (res.alive) validConfigs.push(res);
                });

                checked += batch.length;
                const progress = 30 + ((checked / maxChecks) * 70);
                pBar.style.width = `${progress}%`;
                pText.innerText = `تست: ${checked} | سالم: ${validConfigs.length}`;

                if (validConfigs.length >= limit * 1.5) break;
            }

            validConfigs.sort((a, b) => a.ping - b.ping);
            validConfigs = validConfigs.slice(0, limit);
            
            renderResults();
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('actionBar').classList.remove('hidden');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').innerHTML = `<i class="fas fa-redo"></i> تست مجدد`;
        }

        function smartDecode(str) {
            try {
                str = str.trim();
                if (str.includes('vmess://') || str.includes('vless://')) return str;
                return atob(str.replace(/-/g, '+').replace(/_/g, '/').replace(/\s/g, ''));
            } catch { return str; }
        }

        function extractConfigs(text) {
            return text.match(/(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g) || [];
        }

        async function checkConnectivity(config, timeout) {
            const start = Date.now();
            let host = '', port = 80;

            try {
                if (config.startsWith('vmess')) {
                    const b64 = config.replace('vmess://', '');
                    const json = JSON.parse(smartDecode(b64));
                    host = json.add; port = json.port;
                } else {
                    const match = config.match(/@([^:]+):(\d+)/) || config.match(/\/\/([^:]+):(\d+)/);
                    if (match) { host = match[1]; port = match[2]; }
                }
            } catch { return { alive: false }; }

            if (!host) return { alive: false };

            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                await fetch(`http://${host}:${port}`, { 
                    mode: 'no-cors', 
                    signal: controller.signal 
                });
                
                clearTimeout(id);
                return { alive: true, ping: Date.now() - start, config };
            } catch (err) {
                if (err.name === 'AbortError') return { alive: false };
                return { alive: true, ping: Date.now() - start, config };
            }
        }

        function renderResults() {
            const container = document.getElementById('cardsContainer');
            document.getElementById('countVal').innerText = validConfigs.length;
            
            validConfigs.forEach(item => {
                let type = item.config.split('://')[0].toUpperCase();
                let pingColor = item.ping < 500 ? 'text-green-600' : 'text-yellow-600';
                let name = 'Config';
                if(item.config.includes('#')) name = decodeURIComponent(item.config.split('#')[1]);

                container.innerHTML += `
                    <div class="bg-white border border-gray-100 rounded-xl p-3 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="bg-blue-50 text-blue-600 font-bold text-[10px] px-2 py-1 rounded">${type}</span>
                            <div class="truncate">
                                <div class="font-bold text-xs text-gray-700 truncate w-32">${name}</div>
                                <div class="text-[10px] text-gray-400 font-mono truncate w-32 opacity-70">${item.config}</div>
                            </div>
                        </div>
                        <div class="text-xs font-bold font-mono ${pingColor}">${item.ping}ms</div>
                    </div>
                `;
            });
        }

        function copyAll() {
            const txt = validConfigs.map(c => c.config).join('\n');
            navigator.clipboard.writeText(txt).then(() => alert('کپی شد!'));
        }

        function downloadSub() {
            const txt = validConfigs.map(c => c.config).join('\n');
            const blob = new Blob([btoa(txt)], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Subscription.txt';
            link.click();
        }

        renderSources();
    </script>
</body>
</html>
