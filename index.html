<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ³ØªØ± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯ | Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: { primary: '#2563eb', secondary: '#f1f5f9' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .loader-spin { border: 2px solid #e2e8f0; border-top: 2px solid #2563eb; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ØªØ¨â€ŒÙ‡Ø§ */
        .tab-btn { @apply px-3 py-1 text-xs font-bold rounded-full transition-all border; }
        .tab-btn.active { @apply bg-blue-600 text-white border-blue-600 shadow-md; }
        .tab-btn.inactive { @apply bg-white text-gray-500 border-gray-200 hover:bg-gray-50; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø¯Ø¬ */
        .count-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: #64748b; font-weight: bold; font-family: monospace; }
        .count-badge.loading { background: #eff6ff; color: #2563eb; }
        .count-badge.success { background: #dcfce7; color: #15803d; }
        .count-badge.error { background: #fee2e2; color: #b91c1c; }
        
        .source-checkbox:checked + div { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="pb-36 pt-16">

    <header class="fixed top-0 w-full z-40 bg-white/95 backdrop-blur-md border-b border-gray-200 h-14 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fas fa-check-double"></i>
            </div>
            <h1 class="font-bold text-gray-800 text-base">ØªØ³ØªØ± Ú©Ø§Ù†ÙÛŒÚ¯ <span class="text-[10px] text-gray-400 font-normal">v8.0 Fix</span></h1>
        </div>
        <button onclick="location.reload()" class="text-gray-400 hover:text-blue-600 transition"><i class="fas fa-sync-alt"></i></button>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-5">

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-gray-700 text-xs flex items-center gap-2">
                    <i class="fas fa-server text-blue-500"></i> Ù„ÛŒØ³Øª Ù…Ù†Ø§Ø¨Ø¹
                </h2>
                <div class="flex gap-2">
                    <button onclick="checkAllSourceCounts()" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 border border-blue-100 flex items-center gap-1 transition">
                        <i class="fas fa-search"></i> Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø¬Ù…
                    </button>
                    <button onclick="toggleSources(true)" class="text-[10px] bg-gray-50 text-gray-600 px-2 py-1 rounded hover:bg-gray-100 border border-gray-200">Ù‡Ù…Ù‡</button>
                </div>
            </div>
            
            <div id="sourcesGrid" class="grid grid-cols-1 gap-2 max-h-64 overflow-y-auto custom-scroll p-1">
                </div>
        </section>

        <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 space-y-2">
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-gray-500">Ù„ÛŒÙ†Ú© Ø¯Ø³ØªÛŒ / Ø³Ø§Ø¨Ø³Ú©Ø±ÛŒÙ¾Ø´Ù†</span>
                <span id="manualBadge" class="count-badge hidden"></span>
            </div>
            <div class="relative">
                <textarea id="customInput" class="w-full h-16 p-3 text-xs bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 transition font-mono dir-ltr resize-none" placeholder="Ù„ÛŒÙ†Ú© Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                <button onclick="checkManualLink()" class="absolute bottom-2 right-2 bg-white text-blue-600 border border-blue-100 text-[10px] px-2 py-1 rounded-lg hover:bg-blue-50 transition">
                    Ø¨Ø±Ø±Ø³ÛŒ
                </button>
            </div>
        </div>

        <section class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4">
            <div class="flex justify-between text-xs mb-2">
                <span class="text-gray-600 font-bold">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÙˆØ¬ÛŒ (Ø³Ø§Ù„Ù…â€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§):</span>
                <span id="limitDisplay" class="font-bold text-blue-600 bg-blue-50 px-2 rounded">20</span>
            </div>
            <input type="range" id="limitInput" min="5" max="200" value="20" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="document.getElementById('limitDisplay').innerText = this.value">
            
            <div class="flex gap-3 pt-2">
                <label class="flex-1 flex items-center gap-2 bg-gray-50 p-2.5 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                    <input type="checkbox" id="dedupCheck" class="w-4 h-4 accent-blue-600 rounded" checked>
                    <span class="text-[10px] font-bold text-gray-600">Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒ (IP ÛŒÚ©Ø³Ø§Ù†)</span>
                </label>
                <label class="flex-1 flex items-center gap-2 bg-gray-50 p-2.5 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                    <input type="checkbox" id="strictMode" class="w-4 h-4 accent-blue-600 rounded" checked>
                    <span class="text-[10px] font-bold text-gray-600">ØªØ³Øª Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡</span>
                </label>
            </div>
        </section>

        <div id="controlBtns">
            <button id="startBtn" onclick="startProcess()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm group">
                <span>Ø´Ø±ÙˆØ¹ Ø¢Ù†Ø§Ù„ÛŒØ² Ùˆ ØªØ³Øª</span>
                <i class="fas fa-rocket group-hover:translate-x-1 transition-transform"></i>
            </button>
            
            <button id="stopBtn" onclick="stopProcess()" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition-all active:scale-95 flex justify-center items-center gap-2 text-sm">
                <span>ØªÙˆÙ‚Ù Ø¹Ù…Ù„ÛŒØ§Øª</span>
                <i class="fas fa-stop"></i>
            </button>
        </div>

        <div id="statusArea" class="hidden text-center py-4 space-y-2">
            <div class="flex justify-center items-center gap-2 text-xs text-gray-500">
                <div class="loader-spin"></div>
                <span id="statusText">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div id="progressBar" class="bg-blue-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-4">
            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="filterType('all')" class="tab-btn active" id="tab-all">Ù‡Ù…Ù‡ (<span id="count-all">0</span>)</button>
                <button onclick="filterType('vless')" class="tab-btn inactive" id="tab-vless">VLESS</button>
                <button onclick="filterType('vmess')" class="tab-btn inactive" id="tab-vmess">VMess</button>
                <button onclick="filterType('reality')" class="tab-btn inactive" id="tab-reality">Reality</button>
            </div>

            <div id="cardsContainer" class="space-y-2"></div>
        </div>

    </main>

    <div id="actionBar" class="hidden fixed bottom-6 left-0 w-full px-4 z-40">
        <div class="max-w-xl mx-auto bg-white border border-gray-200 p-2 rounded-2xl shadow-2xl flex gap-2">
            <button onclick="copyAll()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-md active:bg-blue-700 transition flex flex-col items-center justify-center gap-0.5">
                <i class="fas fa-copy mb-0.5"></i> Ú©Ù¾ÛŒ
            </button>
            <button onclick="downloadSub()" class="flex-1 bg-white text-gray-700 border border-gray-200 py-3 rounded-xl font-bold text-xs shadow-sm hover:bg-gray-50 transition flex flex-col items-center justify-center gap-0.5">
                <i class="fas fa-file-download mb-0.5"></i> ÙØ§ÛŒÙ„
            </button>
        </div>
    </div>

    <div id="qrModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onclick="document.getElementById('qrModal').classList.add('hidden')">
        <div class="bg-white rounded-3xl p-6 shadow-2xl text-center w-full max-w-xs transform transition-all scale-100" onclick="event.stopPropagation()">
            <div class="font-bold text-gray-700 mb-4">Ø§Ø³Ú©Ù† Ø¬Ù‡Øª Ø§ØªØµØ§Ù„</div>
            <div id="qrPlace" class="flex justify-center mb-4 p-2 bg-white rounded-xl border border-gray-100"></div>
            <button onclick="document.getElementById('qrModal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <script>
        // --- Ù…Ù†Ø§Ø¨Ø¹ Ø¨Ø±ÙˆØ² Ø´Ø¯Ù‡ ---
        const sources = [
            { id: 's1', name: "AvenCores (Mix)", url: "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/main/githubmirror/1.txt" },
            { id: 's2', name: "HamedCode (VLESS)", url: "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/sub/vless.txt" },
            { id: 's3', name: "V2RayRoot", url: "https://raw.githubusercontent.com/V2RayRoot/V2RayConfig/main/Config/vless.txt" },
            { id: 's4', name: "SoliSpirit", url: "https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/main/all_configs.txt" },
            { id: 's5', name: "ALIILAPRO", url: "https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/server.txt" },
            { id: 's6', name: "MatinGhanbari", url: "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/all_sub.txt" },
            { id: 's7', name: "Barry-Far (Base64)", url: "https://raw.githubusercontent.com/barry-far/V2ray-config/main/All_Configs_base64_Sub.txt" },
            { id: 's8', name: "Epodonios", url: "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt" },
            { id: 's9', name: "Namira", url: "https://www.namira.dev/api/subscription" },
            { id: 's10', name: "ShatakVPN", url: "https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/main/configs/all.txt" }
        ];

        let validConfigs = [];
        let displayedConfigs = [];
        let shouldStop = false;

        // --- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        function renderSources() {
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = '';
            sources.forEach((src, idx) => {
                grid.innerHTML += `
                    <label class="cursor-pointer relative group block">
                        <input type="checkbox" value="${src.url}" data-id="${src.id}" class="source-checkbox hidden" checked>
                        <div class="border border-gray-100 rounded-xl p-3 flex items-center justify-between transition-all hover:bg-white hover:shadow-sm bg-white">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fas fa-check-circle text-blue-500 opacity-0 check-icon transition-transform scale-50"></i>
                                <span class="font-bold text-xs text-gray-600 truncate">${src.name}</span>
                            </div>
                            <div id="badge-${src.id}" class="count-badge">-</div>
                        </div>
                    </label>
                `;
            });
        }

        function toggleSources(state) {
            document.querySelectorAll('.source-checkbox').forEach(cb => cb.checked = state);
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ù‡Ø³ØªÙ‡ (Decoder & Fetcher) ---

        // 1. Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù…Ù† Ø¨Ø§ Ù¾Ø±ÙˆÚ©Ø³ÛŒ (Ø¨Ø±Ø§ÛŒ CORS)
        async function fetchContent(url) {
            const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 10000); // 10 Ø«Ø§Ù†ÛŒÙ‡ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø¯Ø§Ù†Ù„ÙˆØ¯
                const res = await fetch(proxy, { signal: controller.signal });
                clearTimeout(id);
                if (!res.ok) throw new Error('Net');
                return await res.text();
            } catch { return ""; }
        }

        // 2. Ø¯ÛŒÚ©ÙˆØ¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ø´Ø§Ù‡â€ŒÚ©Ù„ÛŒØ¯)
        function smartDecode(text) {
            if (!text) return [];
            text = text.trim();
            let configs = [];
            
            // Ø§Ù„Ù) ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ù…Ø³ØªÙ‚ÛŒÙ…
            const regex = /(vmess|vless|trojan|ss|hy2|tuic):\/\/[^\s\n]+/g;
            const direct = text.match(regex);
            if (direct) configs.push(...direct);

            // Ø¨) ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒÚ©Ø¯ Base64 (Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙØ§ÛŒÙ„ Ú©Ù„Ø§Ù‹ Ø§Ù†Ú©ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
            try {
                const clean = text.replace(/[\s\n]/g, '').replace(/-/g, '+').replace(/_/g, '/');
                const decoded = atob(clean);
                const inside = decoded.match(regex);
                if (inside) configs.push(...inside);
            } catch {}

            return [...new Set(configs)]; // Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡
        }

        // --- Ø¨Ø®Ø´ 1: Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù†Ø§Ø¨Ø¹ ---

        async function checkSelectedSources() {
            const checkedBoxes = document.querySelectorAll('.source-checkbox:checked');
            if (checkedBoxes.length === 0) return alert("Ù…Ù†Ø¨Ø¹ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡!");

            for (const box of checkedBoxes) {
                const url = box.value;
                const id = box.dataset.id;
                const badge = document.getElementById(`badge-${id}`);
                
                badge.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                badge.className = "count-badge loading";
                
                const content = await fetchContent(url);
                const configs = smartDecode(content);
                
                if (configs.length > 0) {
                    badge.className = "count-badge success";
                    badge.innerText = `${configs.length}`;
                } else {
                    badge.className = "count-badge error";
                    badge.innerText = "Error";
                }
            }
        }

        async function checkManualLink() {
            const input = document.getElementById('customInput');
            const badge = document.getElementById('manualBadge');
            const url = input.value.trim();

            if (!url) return;
            
            badge.classList.remove('hidden');
            badge.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            badge.className = "count-badge loading";

            let configs = [];
            if (url.startsWith('http')) {
                const content = await fetchContent(url);
                configs = smartDecode(content);
            } else {
                configs = smartDecode(url);
            }
            
            if (configs.length > 0) {
                badge.innerText = `${configs.length} Ú©Ø§Ù†ÙÛŒÚ¯`;
                badge.className = "count-badge success";
            } else {
                badge.innerText = "ÛŒØ§ÙØª Ù†Ø´Ø¯";
                badge.className = "count-badge error";
            }
        }

        // --- Ø¨Ø®Ø´ 2: Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ ØªØ³Øª ---

        function stopProcess() {
            shouldStop = true;
            document.getElementById('statusText').innerText = "Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù...";
        }

        async function startProcess() {
            shouldStop = false;
            validConfigs = [];
            
            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª UI
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('actionBar').classList.add('hidden');
            document.getElementById('cardsContainer').innerHTML = '';

            const status = document.getElementById('statusText');
            const pBar = document.getElementById('progressBar');
            
            // ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
            const selectedUrls = Array.from(document.querySelectorAll('.source-checkbox:checked')).map(cb => cb.value);
            const custom = document.getElementById('customInput').value;
            const limit = parseInt(document.getElementById('limitInput').value);
            const useDedup = document.getElementById('dedupCheck').checked;
            const strictMode = document.getElementById('strictMode').checked;

            if (selectedUrls.length === 0 && !custom) {
                alert("Ù„Ø·ÙØ§Ù‹ Ù…Ù†Ø¨Ø¹ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!");
                resetUI();
                return;
            }

            // 1. Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ
            let allConfigs = [];
            
            if (custom) {
                if (custom.startsWith('http')) {
                    const c = await fetchContent(custom);
                    allConfigs.push(...smartDecode(c));
                } else {
                    allConfigs.push(...smartDecode(custom));
                }
            }

            for (let i = 0; i < selectedUrls.length; i++) {
                if (shouldStop) break;
                status.innerText = `Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ù†Ø¨Ø¹ ${i + 1} Ø§Ø² ${selectedUrls.length}...`;
                pBar.style.width = `${((i + 1) / selectedUrls.length) * 20}%`;
                
                const content = await fetchContent(selectedUrls[i]);
                allConfigs.push(...smartDecode(content));
            }

            if (shouldStop) { resetUI(); return; }

            // 2. Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒ (Deep Dedup)
            status.innerText = `Ø¢Ù†Ø§Ù„ÛŒØ² ${allConfigs.length} Ú©Ø§Ù†ÙÛŒÚ¯...`;
            if (useDedup) {
                const uniqueMap = new Map();
                allConfigs.forEach(c => {
                    const details = parseConfig(c);
                    if (details) uniqueMap.set(`${details.ip}:${details.port}`, c);
                });
                allConfigs = Array.from(uniqueMap.values());
            } else {
                allConfigs = [...new Set(allConfigs)];
            }

            if (allConfigs.length === 0) {
                alert("Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!");
                resetUI();
                return;
            }

            // 3. ØªØ³Øª Ø³Ø±Ø¹Øª (Strict Check)
            status.innerText = `ØªØ³Øª Ø§ØªØµØ§Ù„ ${allConfigs.length} Ú©Ø§Ù†ÙÛŒÚ¯...`;
            let checked = 0;
            const maxTests = Math.min(allConfigs.length, limit * 5); // Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª
            const batchSize = 15; // Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§

            for (let i = 0; i < maxTests; i += batchSize) {
                if (shouldStop) break;
                
                const batch = allConfigs.slice(i, i + batchSize);
                const promises = batch.map(c => checkConnectivity(c, strictMode));
                const results = await Promise.all(promises);

                results.forEach(res => {
                    if (res.alive) validConfigs.push(res);
                });

                checked += batch.length;
                const percent = 20 + ((checked / maxTests) * 80);
                pBar.style.width = `${percent}%`;
                status.innerText = `Ø¨Ø±Ø±Ø³ÛŒ: ${checked} | Ø³Ø§Ù„Ù…: ${validConfigs.length}`;

                // Ø§Ú¯Ø± Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
                if (validConfigs.length >= limit * 1.1) break;
            }

            // Ù¾Ø§ÛŒØ§Ù†
            validConfigs.sort((a, b) => a.ping - b.ping);
            validConfigs = validConfigs.slice(0, limit);
            displayedConfigs = validConfigs;
            
            filterType('all');
            
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
            document.getElementById('actionBar').classList.remove('hidden');
            resetUI();
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---

        function parseConfig(config) {
            try {
                let ip, port, name = 'Config';
                if (config.startsWith('vmess')) {
                    const b64 = config.replace('vmess://', '');
                    const json = JSON.parse(atob(b64));
                    ip = json.add; port = json.port; name = json.ps;
                } else {
                    const match = config.match(/@([^:]+):(\d+)/) || config.match(/\/\/([^:]+):(\d+)/);
                    if (match) { ip = match[1]; port = match[2]; }
                    if (config.includes('#')) name = decodeURIComponent(config.split('#')[1]);
                }
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø±Ú†Ù…
                let flag = 'ğŸŒ';
                const flagMatch = name ? name.match(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/) : null;
                if (flagMatch) flag = flagMatch[0];

                return { ip, port, name, flag };
            } catch { return null; }
        }

        async function checkConnectivity(config, strict) {
            const start = Date.now();
            const details = parseConfig(config);
            if (!details) return { alive: false };

            try {
                const controller = new AbortController();
                const timeoutMs = strict ? 1500 : 2500; // Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡: 1.5 Ø«Ø§Ù†ÛŒÙ‡
                const id = setTimeout(() => controller.abort(), timeoutMs);
                
                // ØªØ±ÙÙ†Ø¯ Browser Ping:
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙÚ† Ú©Ø±Ø¯Ù† Ø§Ø² Ù¾ÙˆØ±Øª Ø³Ø±ÙˆØ±.
                // Ø§Ú¯Ø± AbortError (Timeout) Ø¨Ø¯Ù‡Ø¯ -> Ø³Ø±ÙˆØ± Ù…Ø±Ø¯Ù‡/ÙÛŒÙ„ØªØ± Ø§Ø³Øª.
                // Ø§Ú¯Ø± NetworkError Ø¨Ø¯Ù‡Ø¯ (ÛŒØ¹Ù†ÛŒ Ø³Ø±ÛŒØ¹ Ø±ÛŒØ¬Ú©Øª Ø´ÙˆØ¯) -> Ø³Ø±ÙˆØ± Ø²Ù†Ø¯Ù‡ Ø§Ø³Øª Ùˆ Ù¾ÙˆØ±Øª Ø¨Ø§Ø² Ø§Ø³Øª.
                // Ø§Ú¯Ø± Success Ø¨Ø¯Ù‡Ø¯ (Ø¨Ø¹ÛŒØ¯ Ø§Ø³Øª) -> Ø³Ø±ÙˆØ± Ø²Ù†Ø¯Ù‡ Ø§Ø³Øª.
                await fetch(`http://${details.ip}:${details.port}`, { mode: 'no-cors', signal: controller.signal });
                
                clearTimeout(id);
                // Ø§Ú¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø³ÛŒØ¯ ÛŒØ¹Ù†ÛŒ ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ù†Ø´Ø¯
                return { alive: true, ping: Date.now() - start, config, details };
            } catch (err) {
                // ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª ÛŒØ¹Ù†ÛŒ Ù…Ø±Ø¯Ù‡
                if (err.name === 'AbortError') return { alive: false };
                
                // Ù‡Ø± Ø§Ø±ÙˆØ± Ø¯ÛŒÚ¯Ø±ÛŒ (Ù…Ø«Ù„ CORS ÛŒØ§ Protocol Error) ÛŒØ¹Ù†ÛŒ Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡
                return { alive: true, ping: Date.now() - start, config, details };
            }
        }

        function filterType(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.className = 'tab-btn inactive');
            document.getElementById(`tab-${type}`).className = 'tab-btn active';
            
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            let list = validConfigs;
            if (type !== 'all') {
                if (type === 'reality') list = validConfigs.filter(c => c.config.includes('security=reality'));
                else list = validConfigs.filter(c => c.config.startsWith(type));
            }
            
            document.getElementById('count-all').innerText = list.length;

            if (list.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 text-xs py-10">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>`;
                return;
            }

            list.forEach(item => {
                const d = item.details;
                const pingColor = item.ping < 500 ? 'text-green-600 bg-green-50' : 'text-yellow-600 bg-yellow-50';
                const proto = item.config.split('://')[0].toUpperCase();

                container.innerHTML += `
                    <div class="bg-white border border-gray-100 rounded-xl p-3 flex justify-between items-center shadow-sm hover:shadow-md transition group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 rounded-lg bg-gray-50 flex items-center justify-center text-lg shadow-sm border border-gray-100">
                                ${d.flag}
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-1.5">
                                    <span class="text-[9px] font-bold bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase tracking-wider">${proto}</span>
                                    <span class="font-bold text-xs text-gray-700 truncate block w-32" title="${d.name}">${d.name || 'Config'}</span>
                                </div>
                                <div class="text-[10px] text-gray-400 font-mono mt-0.5 truncate w-40">${d.ip}:${d.port}</div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] font-bold font-mono px-2 py-0.5 rounded ${pingColor}">${item.ping}ms</span>
                            <button onclick="showQr('${encodeURIComponent(item.config)}')" class="text-gray-400 hover:text-blue-600 transition"><i class="fas fa-qrcode"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        // --- UI Utils ---
        function resetUI() {
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('startBtn').innerHTML = `<span>Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</span><i class="fas fa-redo"></i>`;
        }

        function showQr(config) {
            config = decodeURIComponent(config);
            const modal = document.getElementById('qrModal');
            document.getElementById('qrPlace').innerHTML = '';
            new QRCode(document.getElementById('qrPlace'), { text: config, width: 180, height: 180 });
            modal.classList.remove('hidden');
        }

        function copyAll() {
            const txt = displayedConfigs.map(c => c.config).join('\n'); // ÙÙ‚Ø· ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ú©Ù¾ÛŒ Ú©Ù†Ù‡ ÛŒØ§ Ù‡Ù…Ù‡ØŸ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù…Ù‡ Ø³Ø§Ù„Ù…â€ŒÙ‡Ø§ Ø±Ùˆ Ú©Ù¾ÛŒ Ù…ÛŒÚ©Ù†Ù‡
            navigator.clipboard.writeText(txt).then(() => alert('âœ… Ú©Ù¾ÛŒ Ø´Ø¯!'));
        }

        function downloadSub() {
            const txt = validConfigs.map(c => c.config).join('\n');
            const blob = new Blob([btoa(txt)], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Subscription.txt';
            link.click();
        }

        function checkAllSourceCounts() {
            checkSelectedSources();
        }

        renderSources();
    </script>
</body>
</html>
